<!DOCTYPE html>
<title>Service Worker Performance Tests</title>
<body>
  <script>
  function waitUntilActive(registration) {
    return new Promise(function(resolve, reject) {
      var serviceWorker;
      if (registration.active) {
        resolve(registration.active);
      } else if (registration.waiting) {
        serviceWorker = registration.waiting;
        serviceWorker.onstatechange = checkState;
      } else {
        serviceWorker = registration.installing;
        serviceWorker.onstatechange = checkState;
      }

      function checkState() {
        if (serviceWorker.state == 'activated') {
          serviceWorker.removeEventListener('statechange', checkState);
          resolve(serviceWorker);
        }
      }
    });
  }

  function measureFrameCreation(url) {
    var startTime = performance.now();
    return new Promise(function(resolve) {
      var frame = document.createElement('iframe');
      frame.onload = function() {
        var endTime = performance.now();
        resolve(endTime - startTime, frame);
      };
      frame.src = url;
      document.body.appendChild(frame);
    });
  }

  function addResult(results, key, ms) {
    results['create_iframe_' + key] = {value: ms, units: 'ms'};
  }

  function cleanUp(scope) {
    return navigator.serviceWorker.getRegistration(scope)
      .then(function(r) { r.unregister(); });
  }

  function complete(results) {
    console.log('complete');
    console.log(results);

    var resultNode = document.getElementById('result');
    for (key in results) {
      if (results.hasOwnProperty(key))
        resultNode.innerHTML += '' + key + ': ' +
                                  results[key]['value'] + ' ['
                                + results[key]['units'] + ']<br/>';
    }
    done = true;
  }

  done = false;
  results = { };

  var workerScriptPath = 'empty-worker.js';
  var scope = '/nofetch/';
  var inscopePath = '/nofetch/blank.html';
  var outOfScopePath = 'blank.html';
  
  navigator.serviceWorker.getRegistration(scope)
           .then(waitUntilActive)
           .then(measureFrameCreation.bind(null, 'nofetch/blank.html'))
           .then(addResult.bind(null, results, 'in_scope'))
           .then(measureFrameCreation.bind(null, 'blank.html'))
           .then(addResult.bind(null, results, 'out_of_scope'))
           .then(complete.bind(null, results));
  </script>

  <div id="result"></div>
</body>
